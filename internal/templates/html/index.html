<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Scraper - {{.title}}</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.10.2/dist/cdn.min.js" defer></script>
</head>
<body class="bg-gray-900 text-white" x-data="{ 
    jobs: [],
    newJob: {
        baseUrl: '',
        selectors: [
            { type: 'css', value: '', for: 'links' },
            { type: 'css', value: '', for: 'assets' },
            { type: 'css', value: '', for: 'title' },
            { type: 'css', value: '', for: 'description' },
            { type: 'css', value: '', for: 'pagination' }
        ],
        rules: {
            maxDepth: 3,
            maxAssets: 100,
            includeUrlPattern: '',
            excludeUrlPattern: '',
            timeout: 60,
            requestDelay: 2000,
            randomizeDelay: true
        },
        schedule: ''
    },
    showNewJobForm: false,
    
    fetchJobs() {
        fetch('/api/jobs')
            .then(response => response.json())
            .then(data => {
                this.jobs = data;
            })
            .catch(error => console.error('Error fetching jobs:', error));
    },
    
    createJob() {
        // CLONE THE DATA TO AVOID MODIFYING THE ORIGINAL
        const jobData = JSON.parse(JSON.stringify(this.newJob));
        
        // CONVERT TIMEOUT FROM SECONDS TO NANOSECONDS FOR BACKEND
        if (jobData.rules.timeout) {
            const timeoutSeconds = Number(jobData.rules.timeout);
            if (!isNaN(timeoutSeconds)) {
                jobData.rules.timeout = timeoutSeconds * 1000000000;
            }
        }
        
        // MAKE SURE TO STRINGIFY ANY NUMBERS THAT MIGHT BE IN STRING FORMAT
        if (jobData.rules.requestDelay) {
            jobData.rules.requestDelay = Number(jobData.rules.requestDelay);
        }
        if (jobData.rules.maxDepth) {
            jobData.rules.maxDepth = Number(jobData.rules.maxDepth);
        }
        if (jobData.rules.maxAssets) {
            jobData.rules.maxAssets = Number(jobData.rules.maxAssets);
        }
        
        fetch('/api/jobs', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(jobData)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => {
                    throw new Error('Server error: ' + (err.error || 'Unknown error'));
                });
            }
            return response.json();
        })
        .then(data => {
            this.fetchJobs();
            this.showNewJobForm = false;
            this.resetNewJobForm();
        })
        .catch(error => {
            console.error('Error creating job:', error);
            alert('Error creating job: ' + error.message);
        });
    },
    
    startJob(id) {
        fetch('/api/jobs/' + id + '/start', { method: 'POST' })
            .then(response => response.json())
            .then(data => this.fetchJobs())
            .catch(error => console.error('Error starting job:', error));
    },
    
    stopJob(id) {
        fetch('/api/jobs/' + id + '/stop', { method: 'POST' })
            .then(response => response.json())
            .then(data => this.fetchJobs())
            .catch(error => console.error('Error stopping job:', error));
    },

    nextPage() {
        fetch('/api/jobs/' + this.jobId + '/next-page', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                console.log('Advanced to next page:', data);
                this.fetchJob();
            })
            .catch(error => console.error('Error advancing to next page:', error));
    },

    deleteJob(id) {
        if (confirm('Are you sure you want to delete this job?')) {
            fetch('/api/jobs/' + id, { method: 'DELETE' })
                .then(response => response.json())
                .then(data => this.fetchJobs())
                .catch(error => console.error('Error deleting job:', error));
        }
    },
    
    resetNewJobForm() {
        this.newJob = {
            baseUrl: '',
            selectors: [
                { type: 'css', value: '', for: 'links' },
                { type: 'css', value: '', for: 'assets' },
                { type: 'css', value: '', for: 'title' },
                { type: 'css', value: '', for: 'description' },
                { type: 'css', value: '', for: 'pagination' }
            ],
            rules: {
                maxDepth: 3,
                maxAssets: 100,
                includeUrlPattern: '',
                excludeUrlPattern: '',
                timeout: 60,
                requestDelay: 2000,
                randomizeDelay: true
            },
            schedule: ''
        };
    },
    
    addSelector() {
        this.newJob.selectors.push({ type: 'css', value: '', for: 'links' });
    },
    
    removeSelector(index) {
        this.newJob.selectors.splice(index, 1);
    },
    
    formatDate(dateString) {
        if (!dateString) return 'N/A';
        return new Date(dateString).toLocaleString();
    },
    
    formatStatus(status) {
        const colors = {
            'idle': 'bg-gray-500',
            'running': 'bg-green-500',
            'completed': 'bg-blue-500',
            'failed': 'bg-red-500',
            'stopped': 'bg-yellow-500'
        };
        return colors[status] || 'bg-gray-500';
    }
}" 
x-init="fetchJobs(); setInterval(fetchJobs, 5000)">

    <!-- Header -->
    <header class="bg-gray-800 shadow">
        <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <h1 class="text-3xl font-bold">Web Scraper</h1>
            <div class="flex space-x-4">
                <a href="/gallery" class="px-4 py-2 bg-gray-600 rounded-md hover:bg-gray-700">
                    Asset Gallery
                </a>
                <button 
                    @click="showNewJobForm = true" 
                    class="px-4 py-2 bg-indigo-600 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                >
                    New Job
                </button>
            </div>
        </div>
    </header>

    <!-- Main content -->
    <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        <!-- Jobs list -->
        <div class="bg-gray-800 shadow rounded-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Jobs</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-700">
                    <thead>
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Base URL</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Last Run</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Assets</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-700">
                        <template x-for="job in jobs" :key="job.id">
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <a :href="'/jobs/' + job.id" class="text-indigo-400 hover:text-indigo-300" x-text="job.id.substring(0, 8) + '...'"></a>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap" x-text="job.baseUrl"></td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full" 
                                        :class="formatStatus(job.status)" 
                                        x-text="job.status">
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap" x-text="formatDate(job.lastRun)"></td>
                                <td class="px-6 py-4 whitespace-nowrap" x-text="job.assets ? job.assets.length : 0"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <button 
                                        x-show="job.status !== 'running'"
                                        @click="startJob(job.id)" 
                                        class="text-green-400 hover:text-green-300 mr-3">
                                        Start
                                    </button>
                                    <button 
                                        x-show="job.status === 'running'"
                                        @click="stopJob(job.id)" 
                                        class="text-yellow-400 hover:text-yellow-300 mr-3">
                                        Stop
                                    </button>
                                    <button 
                                        @click="deleteJob(job.id)" 
                                        class="text-red-400 hover:text-red-300">
                                        Delete
                                    </button>
                                </td>
                            </tr>
                        </template>
                        <tr x-show="jobs.length === 0">
                            <td colspan="6" class="px-6 py-4 text-center text-gray-400">No jobs found. Create a new job to get started.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- New Job Modal -->
    <div x-show="showNewJobForm" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-lg max-w-4xl w-full max-h-screen overflow-y-auto" @click.away="showNewJobForm = false">
            <div class="px-6 py-4 border-b border-gray-700">
                <h3 class="text-lg font-medium">Create New Scraping Job</h3>
            </div>
            <div class="p-6">
                <form @submit.prevent="createJob">
                    <!-- Base URL -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-1">Base URL</label>
                        <input type="url" x-model="newJob.baseUrl" required class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    
                    <!-- Selectors -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-1">Selectors</label>
                        <div class="space-y-3">
                            <template x-for="(selector, index) in newJob.selectors" :key="index">
                                <div class="flex space-x-2">
                                    <select x-model="selector.type" class="px-3 py-2 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                        <option value="css">CSS</option>
                                        <option value="xpath">XPath</option>
                                    </select>
                                    <select x-model="selector.for" class="px-3 py-2 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                        <option value="links">Links</option>
                                        <option value="assets">Assets</option>
                                        <option value="title">Title</option>
                                        <option value="description">Description</option>
                                        <option value="author">Author</option>
                                        <option value="date">Date</option>
                                        <option value="pagination">Pagination</option>
                                    </select>
                                    <input type="text" x-model="selector.value" placeholder="Selector value" class="flex-1 px-3 py-2 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                    <button type="button" @click="removeSelector(index)" class="px-3 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">-</button>
                                </div>
                            </template>
                            <button type="button" @click="addSelector" class="px-3 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">+ Add Selector</button>
                        </div>
                    </div>
                    
                    <!-- Rules -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-3">Scraping Rules</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs mb-1">Max Depth</label>
                                <input type="number" x-model="newJob.rules.maxDepth" min="0" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label class="block text-xs mb-1">Max Assets</label>
                                <input type="number" x-model="newJob.rules.maxAssets" min="0" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label class="block text-xs mb-1">Include URL Pattern (regex)</label>
                                <input type="text" x-model="newJob.rules.includeUrlPattern" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label class="block text-xs mb-1">Exclude URL Pattern (regex)</label>
                                <input type="text" x-model="newJob.rules.excludeUrlPattern" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label class="block text-xs mb-1">Timeout (seconds)</label>
                                <input type="number" x-model="newJob.rules.timeout" min="0" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label class="block text-xs mb-1">Request Delay (ms)</label>
                                <input type="number" x-model="newJob.rules.requestDelay" min="0" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" x-model="newJob.rules.randomizeDelay" id="randomizeDelay" class="mr-2">
                                <label for="randomizeDelay" class="text-xs">Randomize Delay</label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Schedule -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium mb-1">Schedule (Cron Expression)</label>
                        <input type="text" x-model="newJob.schedule" placeholder="e.g. */10 * * * *" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        <p class="mt-1 text-xs text-gray-400">Leave empty for manual execution only</p>
                    </div>
                    
                    <!-- Buttons -->
                    <div class="flex justify-end space-x-3">
                        <button type="button" @click="showNewJobForm = false" class="px-4 py-2 bg-gray-600 rounded-md hover:bg-gray-700">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-indigo-600 rounded-md hover:bg-indigo-700">Create Job</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</body>
</html>